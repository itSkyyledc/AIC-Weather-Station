<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visibility Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-color: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
        }
        
        body {
            background-color: var(--background-color);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 2rem;
            padding: 1rem;
        }

        .camera-card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .camera-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .camera-feed-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
        }

        .camera-feed-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .camera-canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
        }

        .camera-info {
            padding: 1.5rem;
            background: white;
        }

        .max-visibility {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: var(--card-shadow);
        }

        .roi-list {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--background-color);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        .roi-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .roi-info {
            flex-grow: 1;
            margin-right: 1rem;
        }

        .roi-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .roi-distance {
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 1rem;
        }

        .metrics {
            flex-grow: 2;
            background: var(--background-color);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .metrics > div {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .metrics > div:last-child {
            margin-bottom: 0;
        }

        .edge-density {
            background-color: rgba(52, 152, 219, 0.1);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }
        
        .visibility-metrics {
            background-color: rgba(46, 204, 113, 0.1);
            padding: 1rem;
            border-radius: 6px;
        }

        .reference-visibility {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #2ecc71;
            font-size: 0.95rem;
        }

        .visibility-score {
            display: inline-block;
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .visibility-score.excellent {
            background-color: #2ecc71;
            color: white;
        }
        .visibility-score.good {
            background-color: #3498db;
            color: white;
        }
        .visibility-score.fair {
            background-color: #f1c40f;
            color: black;
        }
        .visibility-score.poor {
            background-color: #e74c3c;
            color: white;
        }

        .visibility-chart {
            width: 100%;
            height: 300px;
            margin-top: 1rem;
        }

        .btn-roi {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .btn-roi:hover {
            background-color: #2980b9;
        }

        .roi-active {
            background-color: var(--accent-color);
        }

        .visibility-score {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .charts-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .chart-wrapper {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--card-shadow);
        }

        .visibility-chart, .edge-density-chart {
            width: 100%;
            height: 300px;
        }

        .graphs-section {
            margin-top: 1.5rem;
            border-top: 1px solid #eee;
            padding-top: 1.5rem;
        }

        .graphs-section .btn {
            background: var(--secondary-color);
            border: none;
            transition: all 0.3s ease;
        }

        .graphs-section .btn:hover {
            background: var(--primary-color);
            transform: translateY(-1px);
        }

        .graphs-section .btn i {
            margin-right: 0.5rem;
        }

        .collapse {
            transition: all 0.3s ease;
        }

        .roi-overlay {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
        }

        .metrics-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .nav-tabs {
            margin-bottom: 20px;
        }

        .tab-content {
            padding: 20px 0;
        }

        .weather-station-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="/" class="btn btn-outline-light me-3">
                    <i class="fas fa-arrow-left"></i> Back to Weather
                </a>
                <h1 class="mb-0">
                    <img src="/static/images/aiclogo.jpg" alt="Weather Station Logo" style="height: 40px; margin-right: 10px;">
                    Visibility Monitoring Dashboard
                </h1>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="refresh-timer">
                    <i class="fas fa-clock"></i> Next update in <span id="countdown">1800</span>s
                </div>
                <button class="btn btn-light" onclick="refreshAllCameras()">
                    <i class="fas fa-sync-alt"></i> Refresh All
                </button>
            </div>
        </div>
    </div>

    <!-- Add tabs for different sections -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="visibility-tab" data-bs-toggle="tab" data-bs-target="#visibility" type="button" role="tab">
                <i class="fas fa-camera"></i> Visibility Monitoring
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="weather1-tab" data-bs-toggle="tab" data-bs-target="#weather1" type="button" role="tab">
                <i class="fas fa-cloud-sun"></i> Weather Station 1
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="weather2-tab" data-bs-toggle="tab" data-bs-target="#weather2" type="button" role="tab">
                <i class="fas fa-cloud-sun"></i> Weather Station 2
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        <!-- Visibility Monitoring Tab -->
        <div class="tab-pane fade show active" id="visibility" role="tabpanel">
            <div class="camera-grid" id="camera-grid"></div>
        </div>

        <!-- Weather Station 1 Tab -->
        <div class="tab-pane fade" id="weather1" role="tabpanel">
            <div class="weather-station-card">
                <h3>Weather Station 1</h3>
                <div id="weather1-charts"></div>
            </div>
        </div>

        <!-- Weather Station 2 Tab -->
        <div class="tab-pane fade" id="weather2" role="tabpanel">
            <div class="weather-station-card">
                <h3>Weather Station 2</h3>
                <div id="weather2-charts"></div>
            </div>
        </div>
    </div>

    <!-- ROI Distance Input Modal -->
    <div class="modal fade" id="roiDistanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Set ROI Distance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="roiDistance" class="form-label">Distance (meters)</label>
                        <input type="number" class="form-control" id="roiDistance" min="0" step="1">
                    </div>
                    <div class="mb-3">
                        <label for="roiLabel" class="form-label">Label (optional)</label>
                        <input type="text" class="form-control" id="roiLabel" placeholder="e.g., Building A">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmROI()">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let countdown = 1800;
        const cameras = [
            { id: 'camera1', name: 'Camera 1', rtsp_url: 'rtsp://TAPO941A:visibility@192.168.0.112:554/stream1', location: 'Location 1' },
            { id: 'camera2', name: 'Camera 2', rtsp_url: 'rtsp://TAPOC8EA:visibility@192.168.0.111:554/stream1', location: 'Location 2' },
            { id: 'camera3', name: 'Camera 3', rtsp_url: 'rtsp://buth:4ytkfe@192.168.0.100/live/ch00_1', location: 'Location 3' },
            { id: 'camera4', name: 'Camera 4', rtsp_url: 'rtsp://camera4-url', location: 'Location 4' }
        ];

        const cameraROIs = {};
        const fabricCanvases = {};

        let tempROI = null;
        let currentCameraId = null;
        const roiModal = new bootstrap.Modal(document.getElementById('roiDistanceModal'));

        function createCameraCard(camera) {
            return `
                <div class="camera-card" id="${camera.id}-card">
                    <div class="camera-header">
                        <h5 class="mb-0">${camera.name}</h5>
                        <div class="d-flex gap-2">
                            <button class="btn-roi" onclick="toggleROIMode('${camera.id}')" id="${camera.id}-roi-btn">
                                <i class="fas fa-crop"></i> Add ROI
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshCamera('${camera.id}')">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="exportCSV('${camera.id}')">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="camera-feed-container">
                        <div class="camera-feed-wrapper">
                            <canvas id="${camera.id}-canvas" class="camera-canvas"></canvas>
                        </div>
                        <div class="loading-overlay" id="${camera.id}-loading">
                            <i class="fas fa-spinner fa-spin"></i> Updating...
                        </div>
                    </div>
                    <div class="camera-info">
                        <div class="max-visibility" id="${camera.id}-max-visibility">
                            Maximum Visibility: -- m
                        </div>
                        <div class="roi-list" id="${camera.id}-roi-list">
                            <!-- ROI items will be added here -->
                        </div>
                        <div class="graphs-section">
                            <button class="btn btn-primary w-100 mb-3" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#${camera.id}-graphs" aria-expanded="false">
                                <i class="fas fa-chart-line"></i> Show/Hide Graphs
                            </button>
                            <div class="collapse" id="${camera.id}-graphs">
                                <div class="charts-container">
                                    <div class="chart-wrapper">
                                        <div class="visibility-chart" id="${camera.id}-visibility-chart">
                                            <!-- Visibility chart will be added here -->
                                        </div>
                                    </div>
                                    <div class="chart-wrapper">
                                        <div class="edge-density-chart" id="${camera.id}-edge-density-chart">
                                            <!-- Edge density chart will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeFabricCanvas(cameraId) {
            return new Promise((resolve, reject) => {
                const canvasEl = document.getElementById(`${cameraId}-canvas`);
                if (!canvasEl) {
                    reject(new Error('Canvas element not found'));
                    return;
                }

                const container = canvasEl.parentElement;
                
                // Set canvas size to match container
                canvasEl.width = container.clientWidth;
                canvasEl.height = container.clientHeight;

                const canvas = new fabric.Canvas(cameraId + '-canvas', {
                    selection: false,
                    preserveObjectStacking: true
                });

                fabricCanvases[cameraId] = canvas;

                // Load the camera image
                fabric.Image.fromURL(`/api/camera/${cameraId}/snapshot`, function(img) {
                    if (!img) {
                        reject(new Error('Failed to load camera image'));
                        return;
                    }

                    // Calculate scaling to fit the canvas while maintaining aspect ratio
                    const scale = Math.min(
                        canvas.width / img.width,
                        canvas.height / img.height
                    );

                    img.scale(scale);

                    // Center the image
                    img.set({
                        left: (canvas.width - img.width * scale) / 2,
                        top: (canvas.height - img.height * scale) / 2,
                        selectable: false,
                        evented: false
                    });

                    canvas.setBackgroundImage(img, () => {
                        canvas.renderAll();
                        resolve();
                    });
                });
            });
        }

        function toggleROIMode(cameraId) {
            const btn = document.getElementById(`${cameraId}-roi-btn`);
            const canvas = fabricCanvases[cameraId];
            
            if (btn.classList.contains('roi-active')) {
                // Disable ROI mode
                btn.classList.remove('roi-active');
                canvas.off('mouse:down');
                canvas.off('mouse:move');
                canvas.off('mouse:up');
            } else {
                // Enable ROI mode
                btn.classList.add('roi-active');
                let isDrawing = false;
                let rect;

                canvas.on('mouse:down', function(o) {
                    if (isDrawing) return;
                    isDrawing = true;
                    const pointer = canvas.getPointer(o.e);
                    rect = new fabric.Rect({
                        left: pointer.x,
                        top: pointer.y,
                        width: 0,
                        height: 0,
                        fill: 'rgba(52, 152, 219, 0.3)',
                        stroke: '#3498db',
                        strokeWidth: 2
                    });
                    canvas.add(rect);
                });

                canvas.on('mouse:move', function(o) {
                    if (!isDrawing) return;
                    const pointer = canvas.getPointer(o.e);
                    rect.set({
                        width: Math.max(0, pointer.x - rect.left),
                        height: Math.max(0, pointer.y - rect.top)
                    });
                    canvas.renderAll();
                });

                canvas.on('mouse:up', function() {
                    if (!isDrawing) return;
                    isDrawing = false;
                    
                    // Store temporary ROI and show distance modal
                    tempROI = {
                        x: Math.round(rect.left),
                        y: Math.round(rect.top),
                        width: Math.round(rect.width),
                        height: Math.round(rect.height)
                    };
                    currentCameraId = cameraId;
                    roiModal.show();
                });
            }
        }

        function confirmROI() {
            const distance = parseInt(document.getElementById('roiDistance').value);
            const label = document.getElementById('roiLabel').value;
            
            if (!distance || distance <= 0) {
                alert('Please enter a valid distance');
                return;
            }

            tempROI.distance = distance;
            tempROI.label = label || `ROI ${distance}m`;
            
            saveROI(currentCameraId, tempROI);
            roiModal.hide();
            
            // Reset form
            document.getElementById('roiDistance').value = '';
            document.getElementById('roiLabel').value = '';
            
            // Disable ROI mode
            const btn = document.getElementById(`${currentCameraId}-roi-btn`);
            btn.classList.remove('roi-active');
            const canvas = fabricCanvases[currentCameraId];
            canvas.off('mouse:down');
            canvas.off('mouse:move');
            canvas.off('mouse:up');
        }

        function updateROIList(cameraId, data) {
            const roiList = document.getElementById(`${cameraId}-roi-list`);
            const maxVisibilityElement = document.getElementById(`${cameraId}-max-visibility`);
            
            // Display the server-calculated visibility metrics
            maxVisibilityElement.innerHTML = `
                <div class="current-visibility">
                    <div style="font-size: 1.8rem; margin-bottom: 0.5rem;">Maximum Visibility: ${data.max_visibility.toFixed(1)}m</div>
                    <div style="font-size: 1.2rem;">Average Visibility: ${data.avg_visibility.toFixed(1)}m</div>
                </div>
            `;

            if (data.reference && data.reference.best) {
                const bestRef = data.reference.best;
                maxVisibilityElement.innerHTML += `
                    <div class="reference-visibility">
                        <div style="font-weight: 600;">Best Reference Edge Density: ${bestRef.avg_edge_density.toFixed(2)}%</div>
                        <div>Reference Date: ${new Date(bestRef.timestamp).toLocaleString()}</div>
                    </div>
                `;
            }
            
            // Display ROI data from server
            let roiHtml = '';
            data.roi_data.forEach(roi => {
                roiHtml += `
                    <div class="roi-item" data-roi-id="${roi.id}">
                        <div class="roi-info">
                            <div class="roi-label">${roi.label}</div>
                            <div class="roi-distance">Distance: ${roi.distance}m</div>
                        </div>
                        <div class="metrics">
                            <div class="edge-density">
                                <div style="font-weight: 600;">Edge Density Metrics:</div>
                                <div>Current: ${roi.edge_density.toFixed(2)}%</div>
                                ${roi.reference ? `
                                    <div>Reference: ${roi.reference.edge_density.toFixed(2)}%</div>
                                    <div class="visibility-score ${getScoreClass(roi.score)}">
                                        Score: ${roi.score.toFixed(1)}%
                                    </div>
                                ` : ''}
                            </div>
                            <div class="visibility-metrics">
                                <div style="font-weight: 600;">Visibility: ${roi.visibility.toFixed(1)}m</div>
                                <div>Percentage of Range: ${roi.visibility_percentage.toFixed(1)}%</div>
                            </div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteROI('${cameraId}', '${roi.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            roiList.innerHTML = roiHtml;
        }

        function getScoreClass(score) {
            if (score >= 90) return 'excellent';
            if (score >= 70) return 'good';
            if (score >= 50) return 'fair';
            return 'poor';
        }

        function drawROIRect(canvas, coords, label) {
            // Create ROI rectangle
            const rect = new fabric.Rect({
                left: coords.x,
                top: coords.y,
                width: coords.width,
                height: coords.height,
                fill: 'rgba(52, 152, 219, 0.3)',
                stroke: '#3498db',
                strokeWidth: 2,
                selectable: false,
                evented: false
            });

            // Create label
            const text = new fabric.Text(label || '', {
                left: coords.x,
                top: coords.y - 20,
                fontSize: 14,
                fill: '#3498db',
                backgroundColor: 'rgba(255, 255, 255, 0.7)',
                padding: 5,
                selectable: false,
                evented: false
            });

            // Add both to canvas
            canvas.add(rect);
            canvas.add(text);
            canvas.renderAll();

            return [rect, text]; // Return both objects for later reference
        }

        function loadROIs(cameraId) {
            return fetch(`/api/camera/${cameraId}/rois`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load ROIs');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Store ROIs locally
                        cameraROIs[cameraId] = data.rois;
                        
                        // Draw ROIs on canvas
                        const canvas = fabricCanvases[cameraId];
                        Object.entries(data.rois).forEach(([roiId, roi]) => {
                            drawROIRect(canvas, roi.coords, roi.label);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading ROIs:', error);
                    throw error;
                });
        }

        function updateROIOverlay(cameraId, data) {
            const container = document.querySelector(`#${cameraId}-card .camera-feed-container`);
            const canvas = fabricCanvases[cameraId];
            
            // Remove existing overlays
            const existingOverlays = container.querySelectorAll('.roi-overlay');
            existingOverlays.forEach(overlay => overlay.remove());
            
            // Add new overlays for each ROI
            data.roi_data.forEach(roi => {
                const overlay = document.createElement('div');
                overlay.className = 'roi-overlay';
                
                // Calculate position based on ROI coordinates
                const scale = Math.min(
                    canvas.width / canvas.backgroundImage.width,
                    canvas.height / canvas.backgroundImage.height
                );
                
                const x = roi.coords.x * scale + canvas.backgroundImage.left;
                const y = roi.coords.y * scale + canvas.backgroundImage.top;
                
                overlay.style.left = `${x}px`;
                overlay.style.top = `${y}px`;
                
                overlay.innerHTML = `
                    <div>${roi.label}</div>
                    <div>Edge Density: ${roi.edge_density.toFixed(1)}%</div>
                    <div>Visibility: ${roi.visibility.toFixed(1)}m</div>
                `;
                
                container.appendChild(overlay);
            });
        }

        function updateVisibilityChart(cameraId, data) {
            const timestamps = data.history.timestamps || [];
            const maxVisibility = data.history.max_visibility || [];
            const avgVisibility = data.history.avg_visibility || [];
            const roiData = data.history.roi_data || [];

            // Create visibility traces
            const traces = [
                {
                    name: 'Max Visibility',
                    x: timestamps,
                    y: maxVisibility,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#1f77b4' }
                },
                {
                    name: 'Average Visibility',
                    x: timestamps,
                    y: avgVisibility,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#ff7f0e' }
                }
            ];

            // Add ROI traces
            roiData.forEach(roi => {
                if (roi.history && roi.history.visibility) {
                    traces.push({
                        name: `ROI ${roi.label}`,
                        x: timestamps,
                        y: roi.history.visibility,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: '#2ca02c' }
                    });
                }
            });

            // Update visibility chart
            Plotly.newPlot(`${cameraId}-visibility-chart`, traces, {
                title: 'Visibility Over Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Visibility (m)' }
            });

            // Create edge density chart
            const edgeTraces = roiData.map(roi => ({
                name: `ROI ${roi.label}`,
                x: timestamps,
                y: roi.history.edge_density,
                type: 'scatter',
                mode: 'lines'
            }));

            Plotly.newPlot(`${cameraId}-edge-density-chart`, edgeTraces, {
                title: 'Edge Density Over Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Edge Density (%)' }
            });
        }

        function saveROI(cameraId, roi) {
            fetch(`/api/camera/${cameraId}/roi`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(roi)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Store ROI locally
                    if (!cameraROIs[cameraId]) {
                        cameraROIs[cameraId] = {};
                    }
                    cameraROIs[cameraId][data.roi_id] = roi;
                    refreshCamera(cameraId);
                }
            })
            .catch(error => console.error('Error saving ROI:', error));
        }

        function updateCameraImage(cameraId) {
            return new Promise((resolve, reject) => {
                const canvas = fabricCanvases[cameraId];
                if (!canvas) {
                    reject(new Error('Canvas not found'));
                    return;
                }

                // Store existing ROIs
                const existingObjects = canvas.getObjects().filter(obj => obj !== canvas.backgroundImage);
                
                // Load the new camera image
                fabric.Image.fromURL(`/api/camera/${cameraId}/snapshot?t=${Date.now()}`, function(img) {
                    if (!img) {
                        reject(new Error('Failed to load image'));
                        return;
                    }

                    // Calculate scaling to fit the canvas while maintaining aspect ratio
                    const scale = Math.min(
                        canvas.width / img.width,
                        canvas.height / img.height
                    );

                    img.scale(scale);

                    // Center the image
                    img.set({
                        left: (canvas.width - img.width * scale) / 2,
                        top: (canvas.height - img.height * scale) / 2,
                        selectable: false,
                        evented: false
                    });

                    // Clear canvas and set new background
                    canvas.clear();
                    canvas.setBackgroundImage(img, () => {
                        // Restore ROIs
                        existingObjects.forEach(obj => canvas.add(obj));
                        canvas.renderAll();
                        resolve();
                    });
                });
            });
        }

        function showErrorImage(cameraId) {
            const canvas = fabricCanvases[cameraId];
            if (!canvas) return;

            fabric.Image.fromURL('/static/images/error.png', function(img) {
                if (!img) return;

                const scale = Math.min(
                    canvas.width / img.width,
                    canvas.height / img.height
                );

                img.scale(scale);
                img.set({
                    left: (canvas.width - img.width * scale) / 2,
                    top: (canvas.height - img.height * scale) / 2,
                    selectable: false,
                    evented: false
                });

                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
            });
        }

        function refreshCamera(cameraId) {
            if (!cameraId || isRefreshing) return;
            
            isRefreshing = true;
            const loadingOverlay = document.getElementById(`${cameraId}-loading`);
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }

            // Store the current camera image
            const canvas = fabricCanvases[cameraId];
            const currentImage = canvas.backgroundImage;

            // First update the camera image
            updateCameraImage(cameraId)
                .then(() => {
                    return fetch('/refresh_camera', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            camera_id: cameraId,
                            timestamp: new Date().toISOString()
                        })
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to refresh camera data');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Update historical data
                    if (historicalData[cameraId]) {
                        historicalData[cameraId].timestamps.push(data.timestamp);
                        historicalData[cameraId].max_visibility.push(data.max_visibility);
                        historicalData[cameraId].avg_visibility.push(data.avg_visibility);
                        
                        // Update ROI data
                        data.roi_data.forEach((roi, index) => {
                            if (historicalData[cameraId].roi_data[index]) {
                                historicalData[cameraId].roi_data[index].history.visibility.push(roi.visibility);
                                historicalData[cameraId].roi_data[index].history.edge_density.push(roi.edge_density);
                            }
                        });
                    }

                    // Update ROI overlay on camera feed
                    updateROIOverlay(cameraId, data);

                    // Update charts
                    updateVisibilityChart(cameraId, {
                        history: historicalData[cameraId]
                    });

                    // Update ROI list
                    updateROIList(cameraId, data);

                    lastUpdateTime = new Date();
                })
                .catch(error => {
                    console.error('Error refreshing camera:', error);
                    if (currentImage) {
                        canvas.setBackgroundImage(currentImage, canvas.renderAll.bind(canvas));
                    }
                })
                .finally(() => {
                    isRefreshing = false;
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                });
        }

        function refreshAllCameras() {
            console.log('Refreshing all cameras');
            cameras.forEach(camera => refreshCamera(camera.id));
        }

        function updateCountdown() {
            document.getElementById('countdown').textContent = countdown;
            countdown--;
            if (countdown < 0) {
                countdown = 300; // Reset to 5 minutes
                updateVisibilityData();
            }
        }

        function exportCSV(cameraId) {
            // Create a download link and trigger it
            const link = document.createElement('a');
            link.href = `/api/camera/${cameraId}/download/csv`;
            link.download = `visibility_data_${cameraId}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateVisibilityData() {
            cameras.forEach(camera => refreshCamera(camera.id));
        }

        // Add deleteROI function
        function deleteROI(cameraId, roiId) {
            if (!confirm('Are you sure you want to delete this ROI?')) {
                return;
            }

            fetch(`/api/camera/${cameraId}/roi/${roiId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove ROI from local storage
                    if (cameraROIs[cameraId]) {
                        delete cameraROIs[cameraId][roiId];
                    }
                    
                    // Refresh the camera to update the display
                    refreshCamera(cameraId);
                } else {
                    console.error('Error deleting ROI:', data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting ROI:', error);
            });
        }

        // Add window resize handler
        window.addEventListener('resize', () => {
            cameras.forEach(camera => {
                const visibilityChart = document.getElementById(`${camera.id}-visibility-chart`);
                const edgeDensityChart = document.getElementById(`${camera.id}-edge-density-chart`);
                if (visibilityChart && visibilityChart.data) {
                    Plotly.Plots.resize(visibilityChart);
                }
                if (edgeDensityChart && edgeDensityChart.data) {
                    Plotly.Plots.resize(edgeDensityChart);
                }
            });
        });

        // Add function to load historical data on page load
        function loadInitialHistoricalData(cameraId) {
            return new Promise((resolve, reject) => {
                const canvas = fabricCanvases[cameraId];
                if (!canvas) {
                    reject(new Error('Canvas not initialized'));
                    return;
                }

                // Get the current frame data
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                // Send frame data to server
                fetch('/refresh_camera', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        camera_id: cameraId,
                        frame: Array.from(imageData.data),
                        width: canvas.width,
                        height: canvas.height,
                        timestamp: new Date().toISOString()
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to refresh camera');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Update the display with server-calculated data
                    updateROIList(cameraId, data);
                    updateVisibilityChart(cameraId, data);
                    resolve();
                })
                .catch(error => {
                    console.error(`Error loading initial data for ${cameraId}:`, error);
                    reject(error);
                });
            });
        }

        // Update document ready handler
        document.addEventListener('DOMContentLoaded', function() {
            // Create camera grid
            const cameraGrid = document.getElementById('camera-grid');
            cameras.forEach(camera => {
                cameraGrid.innerHTML += createCameraCard(camera);
            });

            // Initialize canvases and load data
            cameras.forEach(async camera => {
                try {
                    // Initialize canvas first
                    await initializeFabricCanvas(camera.id);
                    
                    // Load ROIs
                    await loadROIs(camera.id);
                    
                    // Load initial data
                    await loadInitialHistoricalData(camera.id);
                } catch (error) {
                    console.error(`Error initializing camera ${camera.id}:`, error);
                    showErrorImage(camera.id);
                }
            });
            
            // Initialize periodic updates
            setInterval(updateCountdown, 1000);
            setInterval(updateVisibilityData, 300000); // 5 minutes
        });

        // Add these functions for weather station data handling
        function updateWeatherStationCharts(stationId, data) {
            const timestamps = data.station_data.map(d => new Date(d.timestamp));
            
            // Temperature chart
            const tempTrace = {
                x: timestamps,
                y: data.station_data.map(d => d.temperature),
                name: 'Station Temperature',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#e74c3c' }
            };
            
            const openWeatherTempTrace = {
                x: timestamps,
                y: data.openweather_data.map(d => d.temperature),
                name: 'OpenWeather Temperature',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#c0392b' }
            };
            
            Plotly.newPlot(`${stationId}-temperature-chart`, [tempTrace, openWeatherTempTrace], {
                title: 'Temperature Over Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Temperature (°C)' }
            });
            
            // Humidity chart
            const humidityTrace = {
                x: timestamps,
                y: data.station_data.map(d => d.humidity),
                name: 'Station Humidity',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#3498db' }
            };
            
            const openWeatherHumidityTrace = {
                x: timestamps,
                y: data.openweather_data.map(d => d.humidity),
                name: 'OpenWeather Humidity',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#2980b9' }
            };
            
            Plotly.newPlot(`${stationId}-humidity-chart`, [humidityTrace, openWeatherHumidityTrace], {
                title: 'Humidity Over Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Humidity (%)' }
            });
            
            // Wind speed chart
            const windTrace = {
                x: timestamps,
                y: data.station_data.map(d => d.wind_speed),
                name: 'Station Wind Speed',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#2ecc71' }
            };
            
            const openWeatherWindTrace = {
                x: timestamps,
                y: data.openweather_data.map(d => d.wind_speed),
                name: 'OpenWeather Wind Speed',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#27ae60' }
            };
            
            Plotly.newPlot(`${stationId}-wind-chart`, [windTrace, openWeatherWindTrace], {
                title: 'Wind Speed Over Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Wind Speed (m/s)' }
            });
        }

        function refreshWeatherStation(stationId) {
            fetch(`/api/weather/${stationId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Update current weather display
                    const container = document.getElementById(`${stationId}-charts`);
                    container.innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                <div class="weather-card">
                                    <h4>Current Weather</h4>
                                    <div class="weather-info">
                                        <p>Temperature: ${data.station_data.temperature.toFixed(1)}°C</p>
                                        <p>Humidity: ${data.station_data.humidity}%</p>
                                        <p>Wind Speed: ${data.station_data.wind_speed} m/s</p>
                                        <p>Pressure: ${data.station_data.pressure} hPa</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="chart-container">
                                    <div id="${stationId}-temperature-chart" style="height: 300px;"></div>
                                    <div id="${stationId}-humidity-chart" style="height: 300px;"></div>
                                    <div id="${stationId}-wind-chart" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Fetch historical data and update charts
                    return fetch(`/api/weather/${stationId}/history`);
                })
                .then(response => response.json())
                .then(data => {
                    updateWeatherStationCharts(stationId, data);
                })
                .catch(error => {
                    console.error(`Error refreshing weather station ${stationId}:`, error);
                });
        }

        // Add event listeners for tab changes
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize weather stations
            refreshWeatherStation('station1');
            refreshWeatherStation('station2');
            
            // Add tab change listeners
            const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabEls.forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', function(event) {
                    const targetId = event.target.getAttribute('data-bs-target').substring(1);
                    if (targetId === 'weather1') {
                        refreshWeatherStation('station1');
                    } else if (targetId === 'weather2') {
                        refreshWeatherStation('station2');
                    }
                });
            });
            
            // Set up periodic refresh for weather stations
            setInterval(() => {
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab.id === 'weather1') {
                    refreshWeatherStation('station1');
                } else if (activeTab.id === 'weather2') {
                    refreshWeatherStation('station2');
                }
            }, 300000); // Refresh every 5 minutes
        });
    </script>
</body>
</html> 